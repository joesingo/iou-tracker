{% extends "base.html" %}

{% block title %}
    IOU Tracker - Home
{% endblock %}

{% block extra_style %}
    .trans-table {
        border-collapse: collapse;
    }
    .trans-table td, .trans-table th {
        border: 1px solid #2C3E50;
        padding: 7px 15px;
        text-align: center;
    }
    .trans-table thead tr {
        background: #2C3E50;
        color: #ECF0F1;
    }
    .trans-table tbody tr:hover {
        background: #ECF0F1;
    }
    .trans-table .amount {
        width: 6em;
    }
    .trans-table .comment {
        width: 15em;
    }
    .iou button {
        margin-right: 10px;
    }
    .save-button {
        display: none;
    }
    .owed {
        color: green;
    }
    .debt {
        color: red;
    }
    .error {
        border: 2px solid red;
    }
{% endblock %}

{% block h1_title %}
    IOU Tracker
{% endblock %}

{% block extra_header %}
    <p><a href="/logout/">Logout</a></p>
{% endblock %}

{% block extra_content %}

    {% for i in data %}
        <div class="iou" id="iou{{ loop.index }}" data-person="{{ i }}">
            <h2>{{ i }}</h2>

            <p>
                {% if data[i]["owed"] > 0 %}
                    {{ i }} owes you <span class="owed">{{ data[i]["currency"] }}{{ format_money(data[i]["owed"]) }}</span>
                {% elif data[i]["owed"] < 0 %}
                    You owe {{ i }} <span class="debt">{{ data[i]["currency"] }}{{ format_money(-data[i]["owed"]) }}</span>
                {% else %}
                    You and {{ i }} are even
                {% endif %}
            </p>

            <p>
                <button onclick="addRow({{ loop.index }}, 'You')">I borrowed</button>
                <button onclick="addRow({{ loop.index }}, '{{ i }}')">{{ i }} borrowed</button>
                <button class="save-button" id="save-button{{ loop.index }}" onclick="save({{ loop.index }})">Save</button>
            </p>

            <p style="display: none;" id="error{{ loop.index }}">
                Error saving :(
            </p>

            <table class="trans-table" id="table{{ loop.index }}">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Comment</th>
                    </tr>
                </thead>

                <tbody>

                    {% for t in data[i]["transactions"] %}
                        <tr>
                            <td>{{ t["formatted_date"] }}</td>
                            <td>
                                {% if t["borrower"] == i %}
                                    {{ i }} borrowed <span class="owed">{{ data[i]["currency"] }}{{ format_money(t["amount"]) }}</span>
                                {% else %}
                                    You borrowed <span class="debt">{{ data[i]["currency"] }}{{ format_money(t["amount"]) }}</span>
                                {% endif %}
                            </td>
                            <td>{{ t["comment"] }}</td>
                        </tr>
                    {% else %}
                        <td colspan=3>Nothing to show!</td>
                    {% endfor %}

                </tbody>
            </table>
        </div>

    {% endfor %}

{% endblock %}

{% block extra_body %}

    <script type="text/javascript">

        var addRow = function(id, borrower) {

            // Get date
            var date = new Date();
            var day = date.getDate();
            var month = date.getMonth() + 1;
            var year = date.getFullYear().toString().slice(2);
            // Pad with 0s if necessary
            if (day < 10) day = "0" + day;
            if (month < 10) month = "0" + month;
            var formattedDate = day + "/" + month + "/" + year;

            var table = document.getElementById("table" + id);
            var tbody = table.getElementsByTagName("tbody")[0];

            var borrowerUsername = borrower === "You" ? "{{ username }}" : borrower;

            // Create the new row
            var row = document.createElement("tr");
            row.setAttribute("data-borrower", borrowerUsername);
            row.setAttribute("class", "new-transaction");

            row.innerHTML = `
                <td>${formattedDate}</td>
                <td>${borrower} borrowed <input type="number" placeholder="Amount" class="amount" onfocus="this.className='amount';" min="0.01" step="0.01" /></td>
                <td><input type="text" placeholder="Comment" class="comment" onfocus="this.className='comment';" /></td>
            `;

            row.getElementsByClassName("comment")[0].onkeypress = function(e) {
                // Save when enter is pressed in comment box
                if (e.keyCode === 13) {
                    save(id);
                }
            }

            // Put the new row at the TOP of the table
            var firstRow = tbody.getElementsByTagName("tr")[0];
            tbody.insertBefore(row, firstRow);

            // Show save button
            document.getElementById("save-button" + id).style.display = "inline-block";

            row.getElementsByClassName("amount")[0].focus();
        }

        var save = function(id) {
            var table = document.getElementById("table" + id);
            var newRows = table.getElementsByClassName("new-transaction");

            var data = {
                "person": document.getElementById("iou" + id).getAttribute("data-person"),
                "transactions": []
            };
            var error = false;

            for (var i=0; i<newRows.length; i++) {

                // Check that amount is a positive number with no more than 2dp
                var amount = newRows[i].getElementsByClassName("amount")[0];
                if (amount.value === "" || amount.value - 0 != amount.value
                    || amount.value <= 0 || amount.value.match(/\.\d{3}/)) {
                    amount.className += " error";
                    error = true;
                }

                var borrower = newRows[i].getAttribute("data-borrower");
                var comment = newRows[i].getElementsByClassName("comment")[0];

                // Check that comment is not empty
                if (comment.value === "") {
                    comment.className += " error";
                    error = true;
                }

                data["transactions"].push({
                    "timestamp": Date.now() / 1000,
                    "comment": comment.value,
                    "amount": amount.value,
                    "borrower": borrower
                })
            }

            if (!error) {
                var req = new XMLHttpRequest();
                req.iouId = id;
                req.addEventListener("load", reqListener);
                req.open("POST", "/save/");
                req.setRequestHeader("content-type", "application/json");
                req.send(JSON.stringify(data));
            }
        }

        var reqListener = function() {
            switch (this.status) {
                case 200:
                    document.location.reload(true);
                    break;
                case 500:
                    document.getElementById("error" + this.iouId).style.display = "block";
                    break;
            }
        }

    </script>
{% endblock %}